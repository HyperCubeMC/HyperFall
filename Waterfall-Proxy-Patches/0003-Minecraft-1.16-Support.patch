From 1111f410a6703887817b4a9762186afc54ff152f Mon Sep 17 00:00:00 2001
From: Justsnoopy30 <everettallen30@gmail.com>
Date: Sun, 16 Feb 2020 16:45:16 -0600
Subject: [PATCH] Minecraft 1.16 Support


diff --git a/api/pom.xml b/api/pom.xml
index 07897a44..c0269379 100644
--- a/api/pom.xml
+++ b/api/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-api</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-API</name>
diff --git a/bootstrap/pom.xml b/bootstrap/pom.xml
index c52bda72..d9e302a5 100644
--- a/bootstrap/pom.xml
+++ b/bootstrap/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-bootstrap</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Bootstrap</name>
diff --git a/chat/pom.xml b/chat/pom.xml
index 340f5bb5..1cd23a81 100644
--- a/chat/pom.xml
+++ b/chat/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-chat</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Chat</name>
diff --git a/config/pom.xml b/config/pom.xml
index aecc12bd..072ceff7 100644
--- a/config/pom.xml
+++ b/config/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-config</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Config</name>
diff --git a/event/pom.xml b/event/pom.xml
index e240b786..6eeb3761 100644
--- a/event/pom.xml
+++ b/event/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-event</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Event</name>
diff --git a/log/pom.xml b/log/pom.xml
index 5c5cd781..0c88d5eb 100644
--- a/log/pom.xml
+++ b/log/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-log</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Log</name>
diff --git a/log4j/pom.xml b/log4j/pom.xml
index 1042e092..1fa1a224 100644
--- a/log4j/pom.xml
+++ b/log4j/pom.xml
@@ -5,13 +5,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-log4j</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Log</name>
diff --git a/module/cmd-alert/pom.xml b/module/cmd-alert/pom.xml
index f9c9969a..c16883a9 100644
--- a/module/cmd-alert/pom.xml
+++ b/module/cmd-alert/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-module</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-module-cmd-alert</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>cmd_alert</name>
diff --git a/module/cmd-find/pom.xml b/module/cmd-find/pom.xml
index eccc6959..343d99d4 100644
--- a/module/cmd-find/pom.xml
+++ b/module/cmd-find/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-module</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-module-cmd-find</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>cmd_find</name>
diff --git a/module/cmd-list/pom.xml b/module/cmd-list/pom.xml
index b877613f..be734be5 100644
--- a/module/cmd-list/pom.xml
+++ b/module/cmd-list/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-module</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-module-cmd-list</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>cmd_list</name>
diff --git a/module/cmd-send/pom.xml b/module/cmd-send/pom.xml
index 6aead5e4..b776f439 100644
--- a/module/cmd-send/pom.xml
+++ b/module/cmd-send/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-module</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-module-cmd-send</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>cmd_send</name>
diff --git a/module/cmd-server/pom.xml b/module/cmd-server/pom.xml
index 0ef0b9fd..66ec198e 100644
--- a/module/cmd-server/pom.xml
+++ b/module/cmd-server/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-module</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-module-cmd-server</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>cmd_server</name>
diff --git a/module/pom.xml b/module/pom.xml
index 838adbce..ea62aa04 100644
--- a/module/pom.xml
+++ b/module/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-module</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>pom</packaging>
 
     <name>HyperFall Modules</name>
diff --git a/module/reconnect-yaml/pom.xml b/module/reconnect-yaml/pom.xml
index 265946dc..c804d17d 100644
--- a/module/reconnect-yaml/pom.xml
+++ b/module/reconnect-yaml/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-module</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-module-reconnect-yaml</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>reconnect_yaml</name>
diff --git a/native/pom.xml b/native/pom.xml
index d0a68650..f0fcb2f8 100644
--- a/native/pom.xml
+++ b/native/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-native</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Native</name>
diff --git a/pom.xml b/pom.xml
index 1c695045..77b6b751 100644
--- a/pom.xml
+++ b/pom.xml
@@ -12,7 +12,7 @@
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-parent</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>pom</packaging>
 
     <name>HyperFall-Parent</name>
diff --git a/protocol/pom.xml b/protocol/pom.xml
index 0c51b315..53f48f3f 100644
--- a/protocol/pom.xml
+++ b/protocol/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-protocol</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Protocol</name>
diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java b/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java
index aa1515f4..5e1399a6 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/Protocol.java
@@ -105,6 +105,7 @@ public enum Protocol
                     BossBar::new, // Waterfall - speed up packet construction
                     map( ProtocolConstants.MINECRAFT_1_9, 0x0C ),
                     map( ProtocolConstants.MINECRAFT_1_15, 0x0D )
+
             );
             // Waterfall start
             TO_CLIENT.registerPacket(
diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java b/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java
index cd987c8a..9fa666a2 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/ProtocolConstants.java
@@ -28,6 +28,7 @@ public class ProtocolConstants
     public static final int MINECRAFT_1_15 = 573;
     public static final int MINECRAFT_1_15_1 = 575;
     public static final int MINECRAFT_1_15_2 = 578;
+    public static final int MINECRAFT_1_16 = 707;
     public static final List<String> SUPPORTED_VERSIONS = Arrays.asList(
             "1.8.x",
             "1.9.x",
@@ -36,7 +37,8 @@ public class ProtocolConstants
             "1.12.x",
             "1.13.x",
             "1.14.x",
-            "1.15.x"
+            "1.15.x",
+            "1.16"
     );
     public static final List<Integer> SUPPORTED_VERSION_IDS = Arrays.asList(
             ProtocolConstants.MINECRAFT_1_8,
@@ -60,7 +62,8 @@ public class ProtocolConstants
             ProtocolConstants.MINECRAFT_1_14_4,
             ProtocolConstants.MINECRAFT_1_15,
             ProtocolConstants.MINECRAFT_1_15_1,
-            ProtocolConstants.MINECRAFT_1_15_2
+            ProtocolConstants.MINECRAFT_1_15_2,
+            ProtocolConstants.MINECRAFT_1_16
     );
 
     public static final boolean isBeforeOrEq(int before, int other)
diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/packet/Commands.java b/protocol/src/main/java/net/md_5/bungee/protocol/packet/Commands.java
index 1b0e4474..bdc5cc98 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/packet/Commands.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/packet/Commands.java
@@ -587,6 +587,7 @@ public class Commands extends DefinedPacket
             registerDummy( "minecraft:all_recipes" );
             registerDummy( "minecraft:available_sounds" );
             registerDummy( "minecraft:summonable_entities" );
+            registerDummy( "minecraft:available_biomes" );
         }
 
         private static void registerDummy(String name)
diff --git a/protocol/src/main/java/net/md_5/bungee/protocol/packet/LoginSuccess.java b/protocol/src/main/java/net/md_5/bungee/protocol/packet/LoginSuccess.java
index 2aa5ad58..e32252f0 100644
--- a/protocol/src/main/java/net/md_5/bungee/protocol/packet/LoginSuccess.java
+++ b/protocol/src/main/java/net/md_5/bungee/protocol/packet/LoginSuccess.java
@@ -7,6 +7,7 @@ import lombok.EqualsAndHashCode;
 import lombok.NoArgsConstructor;
 import net.md_5.bungee.protocol.AbstractPacketHandler;
 import net.md_5.bungee.protocol.DefinedPacket;
+import net.md_5.bungee.protocol.ProtocolConstants;
 
 @Data
 @NoArgsConstructor
@@ -21,15 +22,35 @@ public class LoginSuccess extends DefinedPacket
     @Override
     public void read(ByteBuf buf)
     {
+      if ( protocolVersion >= ProtocolConstants.MINECRAFT_1_16 )
+      {
+        uuid = new UUID((long)buf.readInt() << 32 | (long)buf.readInt() & 0xFFFFFFFFL, (long)buf.readInt() << 32 | (long)buf.readInt() & 0xFFFFFFFFL).toString();
+      }
+      else
+      {
         uuid = readString( buf );
-        username = readString( buf );
+      }
+      username = readString( buf );
     }
 
     @Override
     public void write(ByteBuf buf)
     {
+      if ( protocolVersion >= ProtocolConstants.MINECRAFT_1_16 )
+      {
+        UUID theUUID = UUID.fromString(this.uuid);
+        long uuidMostSignificantBits = theUUID.getMostSignificantBits();
+        long uuidLeastSignificantBits = theUUID.getLeastSignificantBits();
+        buf.writeInt((int)(uuidMostSignificantBits >> 32));
+        buf.writeInt((int)uuidMostSignificantBits);
+        buf.writeInt((int)(uuidLeastSignificantBits >> 32));
+        buf.writeInt((int)uuidLeastSignificantBits);
+      }
+      else
+      {
         writeString( uuid, buf );
-        writeString( username, buf );
+      }
+      writeString( username, buf );
     }
 
     @Override
diff --git a/proxy/pom.xml b/proxy/pom.xml
index 65ef6611..8eb97054 100644
--- a/proxy/pom.xml
+++ b/proxy/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-proxy</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Proxy</name>
diff --git a/proxy/src/main/java/net/md_5/bungee/entitymap/EntityMap.java b/proxy/src/main/java/net/md_5/bungee/entitymap/EntityMap.java
index e6afb98d..614ea4f7 100644
--- a/proxy/src/main/java/net/md_5/bungee/entitymap/EntityMap.java
+++ b/proxy/src/main/java/net/md_5/bungee/entitymap/EntityMap.java
@@ -65,6 +65,7 @@ public abstract class EntityMap
             case ProtocolConstants.MINECRAFT_1_15:
             case ProtocolConstants.MINECRAFT_1_15_1:
             case ProtocolConstants.MINECRAFT_1_15_2:
+            case ProtocolConstants.MINECRAFT_1_16:
                 return EntityMap_1_15.INSTANCE;
         }
         throw new RuntimeException( "Version " + version + " has no entity map" );
diff --git a/query/pom.xml b/query/pom.xml
index 48eaf208..eb068344 100644
--- a/query/pom.xml
+++ b/query/pom.xml
@@ -6,13 +6,13 @@
     <parent>
         <groupId>io.github.hyperfallmc</groupId>
         <artifactId>hyperfall-parent</artifactId>
-        <version>1.15-SNAPSHOT</version>
+        <version>1.16-SNAPSHOT</version>
         <relativePath>../pom.xml</relativePath>
     </parent>
 
     <groupId>io.github.hyperfallmc</groupId>
     <artifactId>hyperfall-query</artifactId>
-    <version>1.15-SNAPSHOT</version>
+    <version>1.16-SNAPSHOT</version>
     <packaging>jar</packaging>
 
     <name>HyperFall-Query</name>
-- 
2.17.1

